<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynami-Learn | Professional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --text: #f8fafc; --danger: #ef4444; --info: #f59e0b; }

        /* ×©×™× ×•×™ ×›×™×•×•×Ÿ ×œ×©×××œ-×™××™×Ÿ ×¢×‘×•×¨ ×× ×’×œ×™×ª */
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; direction: ltr; }

        /* ×¦×“ ×©×××œ - ×©×œ×™×˜×” */
        aside { width: 340px; background: #0b1120; border-right: 1px solid #334155; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        h1 { margin: 0; color: var(--accent); font-size: 1.6rem; text-align: center; letter-spacing: 1px; }

        .section { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #334155; }
        .section-title { font-size: 0.85rem; color: #94a3b8; margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 5px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }

        /* ×©×•×¨×•×ª ×›×•×ª×¨×ª ×¢× ×›×¤×ª×•×¨ ××™×“×¢ */
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        label { font-size: 0.9rem; margin: 0; }

        .info-btn {
            background: transparent; border: 1px solid #64748b; color: #64748b;
            width: 16px; height: 16px; border-radius: 50%; font-size: 10px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-family: serif; font-style: italic; transition: 0.2s;
        }
        .info-btn:hover { border-color: var(--info); color: var(--info); }

        .info-box {
            display: none; background: #334155; color: #e2e8f0;
            padding: 10px; border-radius: 4px; margin-bottom: 10px;
            font-size: 0.8rem; line-height: 1.4; border-left: 3px solid var(--info);
            position: relative; animation: fadeIn 0.3s;
        }
        .info-box strong { color: var(--info); }
        .info-box .close-x { position: absolute; top: 2px; right: 5px; cursor: pointer; color: #94a3b8; }

        @keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }

        /* Inputs */
        input[type="range"], select { width: 100%; background: #334155; color: white; border: none; padding: 5px; border-radius: 4px; accent-color: var(--accent); }
        input:disabled, select:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Buttons */
        button.action-btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 5px; transition: 0.2s; text-transform: uppercase; font-size: 0.85rem; }
        .btn-calc { background: var(--accent); color: #000; }
        .btn-calc:hover { background: #fff; }
        .btn-sim { background: var(--danger); color: #fff; }
        .btn-sim:hover { background: #dc2626; }
        .btn-sim.running { background: #64748b; cursor: default; }

        /* Credit */
        .credit-footer {
            margin-top: auto; padding-top: 20px; text-align: center;
            font-size: 0.75rem; color: #64748b; font-family: monospace;
            border-top: 1px solid #1e293b; line-height: 1.5;
        }

        /* Main Area */
        main { flex: 1; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 60% 40%; gap: 15px; }

        .card { background: var(--panel); border: 1px solid #334155; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .card-header { background: rgba(0,0,0,0.3); padding: 10px 15px; font-size: 0.9rem; color: #94a3b8; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; font-weight: 600; text-transform: uppercase; }
        .card-body { flex: 1; position: relative; overflow: auto; padding: 10px; }

        .matrix-container { font-family: 'Consolas', monospace; font-size: 0.85rem; line-height: 1.6; color: #cbd5e1; }
        .mat-row { display: flex; gap: 10px; justify-content: center; }

        #vizCanvas { width: 100%; height: 100%; display: block; background: #000; }

        /* Custom Legend Styling */
        .custom-legend { display: flex; gap: 15px; align-items: center; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; cursor: pointer; user-select: none; text-transform: none; color: #ccc; }
        .legend-item input[type="checkbox"] {
            width: 14px; height: 14px; cursor: pointer; margin: 0; appearance: none;
            border: 2px solid currentColor; border-radius: 3px; display: grid; place-content: center;
        }
        .legend-item input[type="checkbox"]::before {
            content: ""; width: 8px; height: 8px; transform: scale(0);
            transition: 100ms transform ease-in-out; box-shadow: inset 1em 1em currentColor;
        }
        .legend-item input[type="checkbox"]:checked::before { transform: scale(1); }
    </style>
</head>
<body>

<aside>
    <h1>Dynami-Learn</h1>

    <div class="section">
        <div class="section-title">1. Structure Config</div>

        <div class="label-row">
            <label>Stories (DOFs):</label>
            <button class="info-btn" onclick="toggleInfo('info-dof')">i</button>
        </div>
        <div id="info-dof" class="info-box">
            <span class="close-x" onclick="toggleInfo('info-dof')">âœ•</span>
            <strong>Degrees of Freedom:</strong><br>
            Determines the number of masses (floors).
            <br>â€¢ 1: SDOF System (Single frequency).
            <br>â€¢ 2-3: MDOF System (Multiple mode shapes).
        </div>

        <select id="dof-select" onchange="onDofChange()">
            <option value="1">1 Story (SDOF)</option>
            <option value="2" selected>2 Stories (2DOF)</option>
            <option value="3">3 Stories (3DOF)</option>
        </select>
    </div>

    <div class="section">
        <div class="section-title">2. Physical Properties</div>

        <div class="label-row">
            <label>Elastic Modulus (E): <span id="v-E">30</span> GPa</label>
            <button class="info-btn" onclick="toggleInfo('info-E')">i</button>
        </div>
        <div id="info-E" class="info-box">
            <span class="close-x" onclick="toggleInfo('info-E')">âœ•</span>
            <strong>Stiffness (E):</strong><br>
            Represents the material strength.
            <br>â€¢ High E (e.g. Steel) -> Stiff structure -> High Frequency.
            <br>â€¢ Low E -> Flexible structure -> Low Frequency.
        </div>
        <input type="range" id="i-E" min="10" max="50" value="30" oninput="updateUI()">

        <div class="label-row">
            <label>Floor Load (Mass): <span id="v-M">20</span> kN/mÂ²</label>
            <button class="info-btn" onclick="toggleInfo('info-M')">i</button>
        </div>
        <div id="info-M" class="info-box">
            <span class="close-x" onclick="toggleInfo('info-M')">âœ•</span>
            <strong>Mass:</strong><br>
            The weight placed on each floor.
            <br>â€¢ High Mass -> High Inertia -> Low Frequency.
            <br>â€¢ Low Mass -> High Frequency.
        </div>
        <input type="range" id="i-M" min="10" max="100" value="20" oninput="updateUI()">

        <div class="label-row">
            <label>Inertia (Ic): <span id="v-I">0.005</span> mâ´</label>
            <button class="info-btn" onclick="toggleInfo('info-I')">i</button>
        </div>
        <div id="info-I" class="info-box">
            <span class="close-x" onclick="toggleInfo('info-I')">âœ•</span>
            <strong>Moment of Inertia:</strong><br>
            Geometric property of the column cross-section.
            <br>Thicker columns (High Ic) increase stiffness.
        </div>
        <input type="range" id="i-I" min="0.001" max="0.02" step="0.001" value="0.005" oninput="updateUI()">
    </div>

    <button class="action-btn btn-calc" id="btn-calc" onclick="calculateSystem()">ğŸ”„ Calculate Matrices</button>

    <div class="section" style="margin-top:auto;">
        <div class="section-title">3. Simulation</div>

        <div class="label-row">
            <label>Force Freq (Hz): <span id="v-F">2.0</span></label>
            <button class="info-btn" onclick="toggleInfo('info-F')">i</button>
        </div>
        <div id="info-F" class="info-box">
            <span class="close-x" onclick="toggleInfo('info-F')">âœ•</span>
            <strong>Forcing Frequency:</strong><br>
            The rate at which the external force oscillates.
            <br>â€¢ Match Natural Freq -> <strong>Resonance!</strong>
        </div>
        <input type="range" id="i-F" min="0.1" max="5.0" step="0.1" value="2.0" oninput="updateUI()">

        <button class="action-btn btn-sim" id="btn-sim" onclick="toggleSimulation()">ğŸŒŠ Start Earthquake</button>
    </div>

    <div class="credit-footer">
        Powered by<br>
        <strong>Dekel Winkler & Jeremy Scalais</strong>
    </div>
</aside>

<main>
    <div class="card">
        <div class="card-header">Structure Visualizer</div>
        <div class="card-body" style="padding:0; background:#000;">
            <canvas id="vizCanvas"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Modes & Matrices</div>
        <div class="card-body matrix-container" id="results-area">
            Select parameters and click "Calculate Matrices".
        </div>
    </div>

    <div class="card" style="grid-column: span 2;">
        <div class="card-header">
            <span>Time History Response</span>

            <div class="custom-legend">
                <label class="legend-item" style="color: #3b82f6;">
                    <input type="checkbox" id="chk-x" checked onchange="toggleGraph(0)"> Displacement (m)
                </label>
                <label class="legend-item" style="color: #10b981;">
                    <input type="checkbox" id="chk-v" onchange="toggleGraph(1)"> Velocity (m/s)
                </label>
                <label class="legend-item" style="color: #f59e0b;">
                    <input type="checkbox" id="chk-a" onchange="toggleGraph(2)"> Acceleration (m/sÂ²)
                </label>
            </div>
        </div>
        <div class="card-body">
            <canvas id="graphCanvas"></canvas>
        </div>
    </div>
</main>

<script>
    const API = "http://127.0.0.1:8000";
    let chart = null;
    let animId = null;
    let isRunning = false;
    let lastSimData = null;

    // --- Info Box Logic ---
    function toggleInfo(id) {
        const el = document.getElementById(id);
        const isVisible = el.style.display === 'block';
        document.querySelectorAll('.info-box').forEach(box => box.style.display = 'none');
        if (!isVisible) el.style.display = 'block';
    }

    function updateUI() {
        ['E','M','I','F'].forEach(k => document.getElementById('v-'+k).innerText = document.getElementById('i-'+k).value);
    }

    function onDofChange() {
        document.getElementById("results-area").innerText = "Configuration changed. Please recalculate.";
        if (chart) {
            chart.data.datasets.forEach(ds => ds.data = []);
            chart.update();
        }
        const dofs = parseInt(document.getElementById("dof-select").value);
        drawFrame(new Array(dofs).fill(0));
    }

    function toggleSimulation() {
        const btn = document.getElementById("btn-sim");
        if (isRunning) {
            stopSimulation();
            btn.innerText = "ğŸŒŠ Start Earthquake";
            btn.classList.remove("running");
            toggleInputs(false);
        } else {
            runSimulation();
            btn.innerText = "â¹ Stop Simulation";
            btn.classList.add("running");
            toggleInputs(true);
        }
        isRunning = !isRunning;
    }

    function stopSimulation() {
        if(animId) cancelAnimationFrame(animId);
        const dofs = parseInt(document.getElementById("dof-select").value);
        drawFrame(new Array(dofs).fill(0));
    }

    function toggleInputs(locked) {
        ["dof-select", "i-E", "i-M", "i-I", "i-F", "btn-calc"].forEach(id => {
            document.getElementById(id).disabled = locked;
        });
    }

    function getPayload() {
        const dofs = parseInt(document.getElementById("dof-select").value);
        const E = parseFloat(document.getElementById("i-E").value);
        const M = parseFloat(document.getElementById("i-M").value);
        const I = parseFloat(document.getElementById("i-I").value);
        const arr = (v) => Array(dofs).fill().map(() => Array(2).fill(v));
        return {
            "Hc": arr(3.0), "Ec": arr(E), "Ic": arr(I), "Lb": arr(6.0),
            "depth": 6.0, "floor_load": M, "base_condition": 1
        };
    }

    async function calculateSystem() {
        try {
            const payload = getPayload();
            const res = await fetch(`${API}/shear-building/modal`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            displayMatrices(data);
            drawFrame(new Array(data.dofs).fill(0));
        } catch (e) {
            console.error(e);
            alert("Calculation Error (Is server running?)");
        }
    }

    function displayMatrices(data) {
        const div = document.getElementById("results-area");
        let freqs = data.frequencies.map(f => (f/(2*Math.PI)).toFixed(2) + " Hz").join(", ");
        let html = `<div><strong>Natural Frequencies:</strong> [ ${freqs} ]</div><br>`;
        html += `<div><strong>Mass Matrix [M]:</strong></div>`;
        data.M_matrix.forEach(row => html += `<div class="mat-row">[ ${row.map(n => (n/1000).toFixed(1)).join(", ")} ]</div>`);
        html += `<br><div><strong>Stiffness Matrix [K]:</strong></div>`;
        data.K_matrix.forEach(row => html += `<div class="mat-row">[ ${row.map(n => (n/1000).toFixed(0)).join(", ")} ]</div>`);
        div.innerHTML = html;
    }

    async function runSimulation() {
        const freq = parseFloat(document.getElementById("i-F").value);
        const payload = {
            model_req: getPayload(),
            sim_req: {
                "t0": 0, "tf": 10, "dt": 0.02,
                "force_function": { "amp": 200, "freq": freq * 2 * Math.PI }
            }
        };

        try {
            const res = await fetch(`${API}/shear-building/simulate`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();

            lastSimData = data;
            initGraph(data);
            startAnimation(data);

        } catch (e) {
            alert("Simulation Error: " + e.message);
            toggleSimulation();
        }
    }

    // --- Graph Logic ---
    function initGraph(data) {
        const ctx = document.getElementById("graphCanvas").getContext("2d");
        const roofX = data.x[data.x.length-1];
        const roofV = data.v[data.v.length-1];
        const roofA = data.a[data.a.length-1];
        const labels = data.t.map(t=>t.toFixed(2));

        if(chart) chart.destroy();

        // Check checkboxes
        const showX = document.getElementById('chk-x').checked;
        const showV = document.getElementById('chk-v').checked;
        const showA = document.getElementById('chk-a').checked;

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Displacement', data: roofX, borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, hidden: !showX
                    },
                    {
                        label: 'Velocity', data: roofV, borderColor: '#10b981', borderWidth: 2, pointRadius: 0, hidden: !showV
                    },
                    {
                        label: 'Acceleration', data: roofA, borderColor: '#f59e0b', borderWidth: 2, pointRadius: 0, hidden: !showA
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { ticks: {display: false}, grid: {color:'#333'} },
                    y: { grid: {color:'#333'}, ticks: {color:'#94a3b8'} }
                },
                plugins: { legend: { display: false } } // Custom legend used instead
            }
        });
    }

    function toggleGraph(index) {
        if (chart) {
            const isChecked = document.querySelectorAll('.custom-legend input')[index].checked;
            chart.setDatasetVisibility(index, isChecked);
            chart.update();
        }
    }

    function drawFrame(disps) {
        const cvs = document.getElementById("vizCanvas");
        const ctx = cvs.getContext("2d");
        const rect = cvs.parentElement.getBoundingClientRect();
        cvs.width = rect.width; cvs.height = rect.height;

        ctx.fillStyle = "#000";
        ctx.fillRect(0,0,cvs.width,cvs.height);

        const dofs = parseInt(document.getElementById("dof-select").value);
        if (!disps || disps.length !== dofs) disps = new Array(dofs).fill(0);

        const scale = 2000;
        const cx = cvs.width / 2;
        const groundY = cvs.height - 30;
        const floorH = (cvs.height * 0.7) / (dofs || 1);
        const width = 200;

        ctx.lineWidth = 4;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        for (let i = 0; i < dofs; i++) {
            const yBot = groundY - (i * floorH);
            const yTop = groundY - ((i + 1) * floorH);
            const dBot = (i===0) ? 0 : disps[i-1] * scale;
            const dTop = disps[i] * scale;
            const xBot = cx + dBot;
            const xTop = cx + dTop;

            ctx.strokeStyle = "#38bdf8";
            ctx.beginPath(); ctx.moveTo(xBot - width/2, yBot); ctx.lineTo(xTop - width/2, yTop); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(xBot + width/2, yBot); ctx.lineTo(xTop + width/2, yTop); ctx.stroke();

            ctx.strokeStyle = "white";
            ctx.beginPath(); ctx.moveTo(xTop - width/2, yTop); ctx.lineTo(xTop + width/2, yTop); ctx.stroke();

            ctx.fillStyle = "#ef4444";
            ctx.beginPath(); ctx.arc(xTop, yTop, 8, 0, 2*Math.PI); ctx.fill();

            ctx.fillStyle = "#aaa"; ctx.font="12px sans-serif";
            ctx.fillText("M"+(i+1), xTop+10, yTop-10);
        }
        ctx.strokeStyle = "#666"; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(cx - 150, groundY); ctx.lineTo(cx + 150, groundY); ctx.stroke();
    }

    function startAnimation(data) {
        if(animId) cancelAnimationFrame(animId);
        let frame = 0;
        function loop() {
            if (!isRunning) return;
            if (frame >= data.t.length) { frame = 0; }
            const currentDisps = [];
            for(let i=0; i<data.x.length; i++) currentDisps.push(data.x[i][frame]);
            drawFrame(currentDisps);
            frame++;
            animId = requestAnimationFrame(loop);
        }
        loop();
    }

    window.onload = () => { ui(); onDofChange(); };
    window.onresize = () => {
        const dofs = parseInt(document.getElementById("dof-select").value);
        drawFrame(new Array(dofs).fill(0));
    };
</script>
</body>
</html>