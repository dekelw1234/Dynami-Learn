<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynami-Learn | Professional Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --accent: #38bdf8;
            --text: #f8fafc;
            --danger: #ef4444;
            --info: #f59e0b;
            --success: #10b981;
        }

        html { font-size: 14px; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            direction: ltr;
            font-size: 1rem;
        }

        /* --- ◊™◊§◊®◊ô◊ò ◊¶◊ì --- */
        aside {
            width: 320px;
            background: #0b1120;
            border-right: 1px solid #334155;
            padding: 0.6rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 10;
            position: relative;
            transition: 0.3s;
        }

        h1 { margin: 0; color: var(--accent); font-size: 1.2rem; text-align: center; letter-spacing: 1px; font-weight: 800; margin-bottom: 0.2rem; text-transform: uppercase; }

        /* --- ◊©◊ï◊®◊™ ◊î◊õ◊ú◊ô◊ù --- */
        .tools-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #334155;
            gap: 10px;
        }

        .font-group {
            display: flex;
            gap: 2px;
        }

        .tool-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-btn:hover { background: #334155; color: #fff; border-color: #64748b; }

        .fs-icon-btn {
            padding: 4px 10px;
            color: var(--accent);
        }

        /* --- ◊û◊†◊í◊†◊ï◊ü ◊†◊¢◊ô◊ú◊î --- */
        #inputs-area { display: flex; flex-direction: column; gap: 0.4rem; position: relative; flex: 1; }
        #inputs-area.locked > .section { opacity: 0.3; filter: grayscale(1); pointer-events: none; }

        #inputs-area.locked:hover::after {
            content: "üîí Simulation Active.\A Press RESET to edit.";
            white-space: pre-wrap;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid var(--info); color: var(--info);
            padding: 1rem; border-radius: 8px;
            font-size: 0.9rem; font-weight: 600; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
            pointer-events: none; z-index: 100;
            width: 80%;
            animation: smoothPop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes smoothPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        /* --- ◊ê◊ñ◊ï◊® ◊õ◊§◊™◊ï◊®◊ô ◊î◊©◊ú◊ô◊ò◊î --- */
        #controls-area {
            margin-top: auto;
            background: #1e293b;
            padding: 0.6rem;
            border-radius: 6px;
            border: 1px solid #334155;
            display: flex;
            gap: 0.4rem;
            align-items: center;
            flex-shrink: 0;
        }

        .section { background: rgba(255,255,255,0.03); padding: 0.5rem; border-radius: 4px; border: 1px solid #334155; display: flex; flex-direction: column; gap: 0.4rem; }
        .section-title { font-size: 0.75rem; color: #94a3b8; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #334155; padding-bottom: 2px; margin-bottom: 2px; display: flex; justify-content: space-between; align-items: center; }
        .label-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; line-height: 1.2; }
        .input-group { display: flex; gap: 0.3rem; align-items: center; }

        input[type="range"] { flex: 1; height: 4px; background: #334155; border-radius: 2px; appearance: none; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--accent); border-radius: 50%; cursor: pointer; }
        input[type="number"] { width: 4.5em; background: #0f172a; color: var(--accent); border: 1px solid #334155; padding: 2px; border-radius: 3px; text-align: center; font-family: monospace; font-weight: bold; font-size: 0.8rem; }
        select { background:#0f172a; color:white; border:1px solid #334155; border-radius:3px; padding: 3px; font-size:0.8rem; width: 100%; }

        /* ◊°◊ò◊ô◊ô◊ú ◊ú◊û◊¶◊ë Disabled ◊©◊ú ◊î◊°◊ú◊ß◊ò */
        select:disabled { opacity: 0.5; cursor: not-allowed; }

        button.action-btn {
            padding: 6px 12px;
            border: none; border-radius: 4px;
            font-weight: bold; cursor: pointer; transition: 0.2s;
            text-transform: uppercase; font-size: 0.75rem;
            background: #334155; color: #fff; border: 1px solid #475569;
            min-height: 28px;
        }
        button.action-btn:hover { background: #475569; }
        button.calc-btn { background: #0ea5e9; color: #fff; border: none; width: 100%; display: block; margin-top: 0; }
        button.calc-btn:hover { background: #0284c7; }
        button.start-btn { background: #10b981; border: none; flex: 1; }
        button.start-btn:hover { background: #059669; }
        button.start-btn.running { background: #ef4444; }
        button.start-btn.paused { background: #f59e0b; }
        button.reset-btn { background: #475569; max-width: 60px; }

        .credit-footer { margin-top: 5px; padding-top: 5px; font-size: 0.7rem; color: #64748b; text-align: center; border-top: 1px solid #334155; line-height: 1.4; }

        main { flex: 1; padding: 0.6rem; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 50% 50%; gap: 0.6rem; overflow: hidden; }
        .card { background: var(--panel); border: 1px solid #334155; border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .card-header { background: rgba(0,0,0,0.2); padding: 0 0.6rem; font-size: 0.8rem; color: #94a3b8; border-bottom: 1px solid #334155; font-weight: 600; display: flex; justify-content: space-between; align-items: center; min-height: 32px; flex-shrink: 0; }
        .card-body { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .card-footer { padding: 0.4rem; border-top: 1px solid #334155; background: rgba(0,0,0,0.1); flex-shrink: 0; }

        .matrix-container { font-family: 'Consolas', monospace; font-size: 0.9rem; padding: 0.6rem; color: #cbd5e1; line-height: 1.5; overflow: auto; flex: 1; }
        .modes-table { width: 100%; border-collapse: collapse; margin-bottom: 0.5rem; }
        .modes-table th { text-align: left; color: #64748b; font-size: 0.8rem; border-bottom: 1px solid #334155; padding: 4px; }
        .modes-table td { padding: 4px; border-bottom: 1px solid #1e293b; font-size: 0.85rem; }
        .mat-label { color: #94a3b8; font-weight: bold; margin-top: 0.5rem; display: block; font-size: 0.8rem; }
        .mat-row { display: flex; gap: 0.5rem; font-size: 0.9rem; color: var(--accent); white-space: nowrap; }

        .tabs-header { display: flex; flex: 1; overflow-x: auto; height: 100%; }
        .tab-btn { padding: 0 12px; height: 100%; background: transparent; border: none; color: #64748b; cursor: pointer; font-size: 0.75rem; font-weight: 600; border-right: 1px solid #334155; transition: 0.2s; white-space: nowrap; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab-btn.active { background: rgba(56, 189, 248, 0.1); color: var(--accent); border-bottom: 2px solid var(--accent); }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; visibility: hidden; pointer-events: none; }
        .tab-content.active { visibility: visible; pointer-events: auto; }
        .chart-container { position: relative; width: 100%; height: 100%; }
        #vizCanvas { width: 100% !important; height: 100% !important; display: block; }
        .legend-row { display: flex; gap: 0.6rem; font-size: 0.75rem; align-items: center; }
        .graph-scroll-container { height: 20px; background: #0b1120; border-top: 1px solid #334155; display: flex; align-items: center; padding: 0 5px; flex-shrink: 0; }
        #time-slider { width: 100%; cursor: pointer; height: 4px; }

        .info-btn { background: transparent; color: var(--info); border: 1px solid var(--info); border-radius: 50%; width: 14px; height: 14px; font-size: 10px; font-family: serif; font-weight: bold; font-style: italic; cursor: pointer; margin-left: 3px; display: inline-flex; align-items: center; justify-content: center; opacity: 0.8; transition: 0.2s; }
        .info-btn:hover { background: var(--info); color: #000; opacity: 1; }

        .info-tooltip { position: absolute; background: rgba(15, 23, 42, 0.98); border: 1px solid var(--accent); border-left: 3px solid var(--info); color: var(--text); padding: 0; border-radius: 4px; font-size: 0.85rem; z-index: 20000; width: 260px; box-shadow: 0 10px 30px rgba(0,0,0,0.95); animation: popIn 0.2s ease-out; display: flex; flex-direction: column; }
        .tooltip-header { background: rgba(255,255,255,0.05); padding: 0.5rem; cursor: move; font-weight: bold; font-size: 0.9rem; color: var(--info); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .tooltip-content { padding: 0.6rem; line-height: 1.5; white-space: pre-wrap; }
        .tooltip-close { background: transparent; border: none; color: #ef4444; font-weight: bold; font-size: 14px; cursor: pointer; padding: 0 4px;}
        .tooltip-close:hover { transform: scale(1.1); }
        @keyframes popIn { from { opacity:0; transform: scale(0.95); } to { opacity:1; transform: scale(1); } }

        body.sim-running { cursor: not-allowed; }
        body.sim-running aside { pointer-events: none; opacity: 0.9; }
        body.sim-running #controls-area { pointer-events: auto !important; opacity: 1 !important; cursor: default; }
        body.sim-running .tools-row { pointer-events: auto !important; opacity: 1 !important; cursor: default; }
        body.sim-running main { cursor: default; pointer-events: auto !important; }

        @media (max-width: 900px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            aside { width: 100%; height: auto; max-height: 45vh; border-right: none; border-bottom: 2px solid #334155; box-sizing: border-box; }
            main { display: flex; flex-direction: column; gap: 10px; height: auto; overflow: visible; padding-bottom: 40px; }
            .card { min-height: 300px; width: 100%; }
            .card[style*="grid-column: span 2;"] { grid-column: auto !important; }
        }
    </style>
</head>
<body>

<aside id="sidebar">
    <h1>Dynami-Learn</h1>

    <div class="tools-row">
        <div class="font-group">
            <button class="tool-btn" onclick="changeFontSize(-1)">A-</button>
            <button class="tool-btn" onclick="resetFontSize()">Reset Font</button>
            <button class="tool-btn" onclick="changeFontSize(1)">A+</button>
        </div>
        <button class="tool-btn fs-icon-btn" onclick="toggleFullScreen()" title="Full Screen">‚õ∂</button>
    </div>

    <div id="inputs-area">
        <div class="section">
            <div class="section-title">1. Structure <button class="info-btn" onclick="showTooltip('stories', event)">i</button></div>
            <div class="label-row"><label>Stories:</label><select id="dof-select" onchange="onDofChange()"><option value="1">1 Story (SDOF)</option><option value="2" selected>2 Stories (2DOF)</option><option value="3">3 Stories (3DOF)</option></select></div>
        </div>
        <div class="section">
            <div class="section-title">2. Properties</div>
            <div class="label-row"><label>Young's Modulus (E) [GPa]: <button class="info-btn" onclick="showTooltip('E', event)">i</button></label></div>
            <div class="input-group"><input type="range" id="slide-E" min="10" max="50" value="30" oninput="syncInputs('E', true)"><input type="number" id="num-E" value="30" min="1" max="50" oninput="syncInputs('E', false)" onchange="validateInput('E')"></div>

            <div class="label-row"><label>Floor Load (q) [kN/m¬≤]: <button class="info-btn" onclick="showTooltip('mass', event)">i</button></label></div>
            <div class="input-group"><input type="range" id="slide-M" min="10" max="100" value="50" oninput="syncInputs('M', true)"><input type="number" id="num-M" value="50" min="1" max="100" oninput="syncInputs('M', false)" onchange="validateInput('M')"></div>

            <div class="label-row" style="border-top:1px dashed #334155; padding-top:4px; margin-top:2px;"><label>Profile:</label><select id="profile-type" onchange="updateProfileType()" style="width: auto;"><option value="circle">Circular</option><option value="rect">Rectangular</option></select></div>
            <div id="geo-inputs"></div>
            <div style="font-size:0.7rem; color:#64748b; margin-top: -2px;">Ic: <span id="val-Ic">...</span> m‚Å¥</div>
        </div>
        <div class="section">
            <div class="section-title">3. Damping (Zeta 0-1) <button class="info-btn" onclick="showTooltip('damping', event)">i</button></div>
            <div id="damping-container" style="display:flex; flex-direction:column; gap:4px;"></div>
        </div>

        <div class="section">
            <div class="section-title">4. Simulation Setup</div>
            <div class="label-row"><label>Type:</label>
                <select id="force-type" onchange="toggleDuration()" style="width:auto;">
                    <option value="continuous">Harmonic Load - nonstop</option>
                    <option value="pulse" selected>Harmonic Load - with stopping point</option>
                </select>
            </div>
            <div id="dur-box" style="margin-bottom:2px;"><div class="label-row"><label>Duration (s):</label></div><div class="input-group"><input type="range" id="slide-dur" min="0.5" max="10" step="0.1" value="2" oninput="syncInputs('dur', true)"><input type="number" id="num-dur" value="2" min="0.1" max="50" oninput="syncInputs('dur', false)" onchange="validateInput('dur')"></div></div>

            <div class="label-row"><label>Freq (Hz): <span id="val-w" style="color:var(--info); font-size:0.65rem;"></span> <button class="info-btn" onclick="showTooltip('freq', event)">i</button></label></div>

            <div id="mode-presets" style="display:flex; gap:4px; margin-bottom:6px; flex-wrap:wrap; min-height:20px;"></div>

            <div class="input-group">
            <input type="range" id="slide-F" min="0.1" max="10" step="0.01" value="2" oninput="syncInputs('F', true)">
                <input type="number" id="num-F" value="2" min="0.1" max="20" step="0.0001" oninput="syncInputs('F', false)" onchange="validateInput('F')">
            </div>
        </div>
    </div>

    <div id="controls-area">
        <select id="sim-speed" style="width:65px; height:28px; font-weight:bold; color:var(--info); background:#0f172a; border:1px solid #475569; border-radius:4px; padding:0 4px; margin-right:auto;">
            <option value="0.25">0.25x</option>
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1.0x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2.0x</option>
        </select>
        <button id="btn-sim" class="action-btn start-btn" onclick="toggleSimulation()">Start</button>
        <button id="btn-reset" class="action-btn reset-btn" onclick="resetSimulation()">Reset</button>
    </div>

    <div class="credit-footer">
        Powered by Dekel Winkler & Jeremy Scalais<br>
        <span style="opacity:0.8">Led by Dr. Assaf Shmerling</span>
    </div>
</aside>
<main>
    <div class="card"><div class="card-header">VISUALIZER</div><div class="card-body" style="background:#000; padding:0;"><canvas id="vizCanvas"></canvas></div></div>
    <div class="card">
        <div class="card-header">SYSTEM PROPERTIES</div>
        <div class="card-body matrix-container" id="results-area">System not calculated yet.</div>
        <div class="card-footer"><button class="action-btn calc-btn" onclick="calculateSystem()">Calculate Matrices</button></div>
    </div>
    <div class="card" style="grid-column: span 2;">
        <div class="card-header" style="padding:0; padding-right:10px;">
            <div id="tabs-header" class="tabs-header"></div>
            <div class="legend-row">
                <label class="legend-item" style="color:#38bdf8"><input type="checkbox" id="chk-x" checked onchange="updateGraphVisibility()"> Disp [m]</label>
                <label class="legend-item" style="color:#10b981"><input type="checkbox" id="chk-v" checked onchange="updateGraphVisibility()"> Vel [m/s]</label>
                <label class="legend-item" style="color:#f59e0b"><input type="checkbox" id="chk-a" checked onchange="updateGraphVisibility()"> Acc [m/s¬≤]</label>
            </div>
        </div>
        <div id="tabs-body" class="card-body" style="padding:0; border-bottom: none;"></div>
        <div class="graph-scroll-container"><input type="range" id="time-slider" min="0" max="100" value="100" step="0.1" oninput="onTimeScroll()"></div>
    </div>
</main>

<script>
    const isLocal = window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost";
    const BASE_URL = isLocal ? "127.0.0.1:8000" : "dynami-learn.onrender.com";
    const PROTOCOL = isLocal ? "http" : "https";
    const WS_PROTOCOL = isLocal ? "ws" : "wss";
    const API_URL = `${PROTOCOL}://${BASE_URL}`;
    const WS_URL = `${WS_PROTOCOL}://${BASE_URL}/ws/simulate`;
    console.log(`Running in ${isLocal ? "LOCAL" : "CLOUD"} mode. Connected to: ${API_URL}`);

    // --- Font Size Control ---
    let currentFontSize = 14;
    function changeFontSize(delta) {
        currentFontSize += delta;
        if (currentFontSize < 12) currentFontSize = 12;
        if (currentFontSize > 18) currentFontSize = 18;
        document.documentElement.style.fontSize = currentFontSize + 'px';
    }
    function resetFontSize() {
        currentFontSize = 14;
        document.documentElement.style.fontSize = '14px';
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => console.log(err));
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    let ws = null, isRunning = false, isPaused = false;
    let systemPeriods = [], activeCharts = [], maxAbsDisp = 0.00001;
    let maxTimeRecorded = 0, isAutoScroll = true;
    let lastState = { t:0, all_x:null, all_v:null };
    let exactFreqFromSet = null;

    const tooltipsData = {
        "stories": { title: "Stories (DOF)", text: "‚Ä¢ SDOF (1): Single equation.\n‚Ä¢ MDOF (2-3): Multiple coupled equations." },
        "E": { title: "Young's Modulus (E)", text: "‚Ä¢ Material stiffness (Stress/Strain).\n‚Ä¢ Higher E = Stiffer building." },
        "mass": { title: "Floor Load (q)", text: "‚Ä¢ Seismic weight [kN/m¬≤].\n‚Ä¢ Mass (M) = (q √ó Area) / g." },
        "damping": { title: "Damping (Œ∂)", text: "‚Ä¢ Energy loss coefficient.\n‚Ä¢ 0.02 is standard for concrete." },
        "freq": { title: "Forcing Freq (œâ)", text: "‚Ä¢ External oscillation rate.\n‚Ä¢ Matching natural freq = Resonance!" }
    };

    function showTooltip(key, event) {
        closeAllTooltips();
        event.stopPropagation();
        const div = document.createElement('div');
        div.className = 'info-tooltip';
        const content = tooltipsData[key] || { title: "Info", text: "..." };
        div.innerHTML = `<div class="tooltip-header"><span>${content.title}</span><button class="tooltip-close" onclick="closeAllTooltips()">‚úï</button></div><div class="tooltip-content">${content.text}</div>`;
        const btnRect = event.target.getBoundingClientRect();
        let top = window.scrollY + btnRect.top;
        let left = window.scrollX + btnRect.left + 20;
        if (top > window.innerHeight - 150) top -= 120;
        div.style.top = top + 'px'; div.style.left = left + 'px';
        document.body.appendChild(div);
        makeDraggable(div);
    }

    function makeDraggable(el) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        const header = el.querySelector(".tooltip-header");
        if (header) header.onmousedown = dragMouseDown;
        function dragMouseDown(e) { e = e || window.event; e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
        function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; el.style.top = (el.offsetTop - pos2) + "px"; el.style.left = (el.offsetLeft - pos1) + "px"; }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
    }

    function closeAllTooltips() { document.querySelectorAll('.info-tooltip').forEach(el => el.remove()); }
    document.addEventListener('click', (e) => { if (!e.target.closest('.info-tooltip') && !e.target.classList.contains('info-btn')) closeAllTooltips(); });

    // --- ◊™◊ô◊ß◊ï◊ü: ◊§◊ú◊ê◊í◊ô◊ü ◊ú◊¶◊ô◊ï◊® ◊ß◊ï ◊ô◊®◊ï◊ß ◊ë◊°◊ô◊ï◊ù ◊î◊®◊¢◊ô◊ì◊î ---
    const quakePlugin = {
        id: 'quakeLine',
        afterDraw: (chart) => {
            const type = document.getElementById('force-type').value;
            if (type !== 'pulse') return;
            const dur = parseFloat(document.getElementById('num-dur').value);
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            // ◊î-Custom Period ◊†◊©◊û◊® ◊ë-chart options
            const T = chart.options.scales.x.customPeriod;
            if (!T) return;

            const xVal = dur / T;
            if (xVal < xAxis.min || xVal > xAxis.max) return;

            const xPixel = xAxis.getPixelForValue(xVal);

            ctx.save();
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#10b981'; // ◊¶◊ë◊¢ ◊ô◊®◊ï◊ß (◊õ◊û◊ï Vel)
            ctx.setLineDash([5, 5]); // ◊ß◊ï ◊û◊ß◊ï◊ï◊ß◊ï
            ctx.moveTo(xPixel, yAxis.top);
            ctx.lineTo(xPixel, yAxis.bottom);
            ctx.stroke();
            ctx.restore();
        }
    };
    Chart.register(quakePlugin);

    window.onload = function() {
        console.log("Initializing...");
        updateProfileType();
        syncInputs('E', true); syncInputs('M', true); syncInputs('F', true); syncInputs('dur', true);
        const dofSelect = document.getElementById('dof-select');
        if (dofSelect) {
            dofSelect.value = "2";
            onDofChange();
        } else {
            setTimeout(calculateSystem, 500);
        }
    };

    function setControlsState(shouldLock) {
        const inputArea = document.getElementById('inputs-area');
        if (shouldLock) inputArea.classList.add('locked'); else inputArea.classList.remove('locked');
    }

    function toggleSimulation() {
        const btn = document.getElementById("btn-sim");
        const speedSel = document.getElementById("sim-speed");
        if (isRunning) {
            if (ws) ws.close();
            isRunning = false; isPaused = true;
            btn.innerText = "Resume"; btn.className = "action-btn start-btn paused";
            document.body.classList.remove("sim-running");
            // ◊©◊ó◊®◊ï◊® ◊û◊î◊ô◊®◊ï◊™ ◊õ◊©◊î◊°◊ô◊û◊ï◊ú◊¶◊ô◊î ◊¢◊ï◊¶◊®◊™
            speedSel.disabled = false;
        } else {
            setControlsState(true);
            // ◊†◊¢◊ô◊ú◊™ ◊û◊î◊ô◊®◊ï◊™ ◊õ◊©◊î◊°◊ô◊û◊ï◊ú◊¶◊ô◊î ◊®◊¶◊î
            speedSel.disabled = true;
            startWebSocket();
        }
    }

    function resetSimulation() {
        if (ws) ws.close();
        isRunning = false; isPaused = false;
        setControlsState(false);
        const btn = document.getElementById("btn-sim");
        const speedSel = document.getElementById("sim-speed");
        btn.innerText = "Start"; btn.className = "action-btn start-btn";
        document.body.classList.remove("sim-running");
        speedSel.disabled = false; // ◊©◊ó◊®◊ï◊® ◊û◊î◊ô◊®◊ï◊™
        lastState = { t: 0, all_x: null, all_v: null };
        maxTimeRecorded = 0; isAutoScroll = true;
        document.getElementById('time-slider').value = 0; maxAbsDisp = 0.00001;
        activeCharts.forEach(obj => { obj.chart.data.datasets.forEach(ds => ds.data = []); obj.chart.options.scales.x.min = 0; obj.chart.options.scales.x.max = 20; obj.chart.update(); });
        const dofs = parseInt(document.getElementById('dof-select').value);
        drawFrame(new Array(dofs).fill(0));
    }

    async function startWebSocket() {
        if (ws) ws.close();
        if (systemPeriods.length === 0) await calculateSystem();

        const startT = isPaused ? lastState.t : 0;
        const initialConds = isPaused ? { x0: lastState.all_x, v0: lastState.all_v } : {};
        const speedFactor = parseFloat(document.getElementById("sim-speed").value);

        let freqToSend;
        let isResonanceMode = false;

        if (exactFreqFromSet !== null) {
            freqToSend = exactFreqFromSet;
            isResonanceMode = true;
            console.log("Using RAW SERVER OMEGA (High Precision Mode)");
        } else {
            freqToSend = parseFloat(document.getElementById("num-F").value) * 2 * Math.PI;
            console.log("Using MANUAL frequency");
        }

        let minPeriod = systemPeriods.length > 0 ? Math.min(...systemPeriods) : 0.2;
        let safeDt;

        if (isResonanceMode) {
            safeDt = Math.max(0.002, minPeriod / 50);
            console.log(`üöÄ HIGH PRECISION DT: ${safeDt.toFixed(6)}s (Period/50)`);
        } else {
            safeDt = Math.min(0.02, Math.max(0.005, minPeriod / 30));
            console.log(`‚ÑπÔ∏è Standard DT: ${safeDt.toFixed(6)}s`);
        }

        const payload = {
            model_req: getModelPayload(),
            sim_req: {
                t0: startT,
                dt: safeDt,
                force_function: {
                    type: document.getElementById("force-type").value,
                    amp: 1000,
                    freq: freqToSend,
                    duration: parseFloat(document.getElementById("num-dur").value)
                },
                damping_ratios: getDampingValues(),
                initial_conditions: initialConds
            }
        };

        ws = new WebSocket(WS_URL);
        const btn = document.getElementById("btn-sim");
        btn.innerText = "Connecting...";

        ws.onopen = () => {
            ws.send(JSON.stringify(payload));
            isRunning = true; isAutoScroll = true;
            document.body.classList.add("sim-running");
            btn.innerText = "Stop"; btn.className = "action-btn start-btn running";
            if (!isPaused) activeCharts.forEach(obj => { obj.chart.data.datasets.forEach(ds => ds.data = []); obj.chart.update(); });
        };
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'DATA') {
                const rawTime = msg.t; maxTimeRecorded = rawTime;
                lastState.t = rawTime; lastState.all_x = msg.all_x; lastState.all_v = msg.all_v;
                const slider = document.getElementById('time-slider');
                slider.max = rawTime;
                if(isAutoScroll) slider.value = rawTime;

                activeCharts.forEach(obj => {
                    const chart = obj.chart; const T = obj.period; const normT = rawTime / T;
                    chart.data.datasets[0].data.push({x: normT, y: msg.x});
                    if(msg.v !== undefined) chart.data.datasets[1].data.push({x: normT, y: msg.v});
                    chart.data.datasets[2].data.push({x: normT, y: msg.a});
                    if (isAutoScroll) {
                        const win = 20;
                        if (normT > win) { chart.options.scales.x.min = normT - win; chart.options.scales.x.max = normT; }
                        else { chart.options.scales.x.min = 0; chart.options.scales.x.max = win; }
                        chart.update('none');
                    }
                });
                drawFrame(msg.all_x);
            } else if (msg.type === 'ERROR') { alert("Server Error: " + msg.message); toggleSimulation(); }
        };
        ws.onclose = () => { if(isRunning) toggleSimulation(); };
    }

    // --- ◊™◊ô◊ß◊ï◊ü: ◊í◊ú◊ô◊ú◊î ◊ó◊õ◊û◊î. ◊ê◊ù ◊í◊ï◊®◊®◊ô◊ù ◊ú◊°◊ï◊£, ◊î◊í◊ú◊ô◊ú◊î ◊î◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™ ◊ó◊ï◊ñ◊®◊™ ---
    function onTimeScroll() {
        const slider = document.getElementById('time-slider');
        const val = parseFloat(slider.value);
        const max = parseFloat(slider.max);

        // ◊ê◊ù ◊î◊û◊©◊™◊û◊© ◊í◊®◊® ◊ê◊™ ◊î◊°◊ú◊ô◊ô◊ì◊® ◊¢◊ì ◊î◊°◊ï◊£ (◊ê◊ï ◊ß◊®◊ï◊ë ◊û◊ê◊ï◊ì ◊ú◊°◊ï◊£), ◊û◊ó◊ñ◊ô◊®◊ô◊ù ◊ê◊™ ◊î◊í◊ú◊ô◊ú◊î ◊î◊ê◊ï◊ò◊ï◊û◊ò◊ô◊™
        if (val >= max - 0.5) {
            isAutoScroll = true;
        } else {
            isAutoScroll = false;
        }

        activeCharts.forEach(obj => {
            const chart = obj.chart; const T = obj.period; const normVal = val / T; const win = 20;
            if (normVal > win) { chart.options.scales.x.min = normVal - win; chart.options.scales.x.max = normVal; }
            else { chart.options.scales.x.min = 0; chart.options.scales.x.max = win; }
            chart.update();
        });
    }

    function initTabsAndCharts(periods) {
        const header = document.getElementById('tabs-header');
        const body = document.getElementById('tabs-body');
        header.innerHTML = ''; body.innerHTML = '';
        activeCharts.forEach(c => c.chart.destroy()); activeCharts = [];
        periods.forEach((T, i) => {
            const modeNum = i + 1;
            const btn = document.createElement('button');
            btn.className = `tab-btn ${i === 0 ? 'active' : ''}`;
            btn.innerText = `Mode ${modeNum} (T=${T.toFixed(3)}s)`;
            btn.onclick = () => switchTab(i);
            header.appendChild(btn);
            const contentDiv = document.createElement('div');
            contentDiv.className = `tab-content ${i === 0 ? 'active' : ''}`;
            const canvasContainer = document.createElement('div');
            canvasContainer.className = 'chart-container';
            const canvas = document.createElement('canvas');
            canvasContainer.appendChild(canvas);
            contentDiv.appendChild(canvasContainer);
            body.appendChild(contentDiv);
            const ctx = canvas.getContext('2d');
            const newChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [
                    { label: 'Disp [m]', data: [], borderColor: '#38bdf8', borderWidth: 2, pointRadius: 0, hidden: !document.getElementById('chk-x').checked },
                    { label: 'Vel [m/s]', data: [], borderColor: '#10b981', borderWidth: 2, pointRadius: 0, hidden: !document.getElementById('chk-v').checked },
                    { label: 'Acc [m/s¬≤]', data: [], borderColor: '#f59e0b', borderWidth: 2, pointRadius: 0, hidden: !document.getElementById('chk-a').checked }
                ]},
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    scales: {
                        x: {
                            type: 'linear', min: 0, max: 20, grid: {color:'#334155'},
                            title: {display:true, text:`Normalized Time (t / T${modeNum})`, color:'#94a3b8'},
                            customPeriod: T,
                            ticks: { color: '#94a3b8', stepSize: 1, callback: function(value) { return Math.round(value); } }
                        },
                        y: { grid: {color:'#334155'}, ticks: { color:'#94a3b8', callback: (v) => Number(v).toExponential(1) } }
                    },
                    plugins: { legend: {display:false} }
                }
            });
            activeCharts.push({ chart: newChart, period: T });
        });
    }

    function switchTab(index) {
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach((b, i) => b.classList.toggle('active', i === index));
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach((c, i) => c.classList.toggle('active', i === index));
        if(activeCharts[index]) setTimeout(() => activeCharts[index].chart.resize(), 10);
    }

    function updateGraphVisibility() {
        activeCharts.forEach(obj => {
            const c = obj.chart;
            c.setDatasetVisibility(0, document.getElementById('chk-x').checked);
            c.setDatasetVisibility(1, document.getElementById('chk-v').checked);
            c.setDatasetVisibility(2, document.getElementById('chk-a').checked);
            c.update();
        });
    }

    function syncInputs(id, fS) {
        const s=document.getElementById('slide-'+id), n=document.getElementById('num-'+id);
        if(fS) n.value=s.value; else s.value=n.value;
        if(['r','b','h'].includes(id)) updateGeometry();
        if(id==='F') document.getElementById('val-w').innerText=`(œâ=${(parseFloat(n.value)*2*Math.PI).toFixed(4)})`;
    }

    window.setFreqFromMode = function(freqHz, rawOmega) {
        const numInput = document.getElementById('num-F');
        const rangeInput = document.getElementById('slide-F');
        exactFreqFromSet = rawOmega;
        numInput.value = freqHz.toFixed(4);
        rangeInput.value = freqHz;
        syncInputs('F', false);
    }

    function validateInput(id) {
        if (id === 'F') {
            exactFreqFromSet = null;
            console.log("Manual input detected. Exact frequency cleared.");
        }
        const n=document.getElementById('num-'+id), s=document.getElementById('slide-'+id);
        let v=parseFloat(n.value); if(isNaN(v)) v=parseFloat(n.min); n.value=v; s.value=v;
        if(['r','b','h'].includes(id)) updateGeometry();
        if(id !== 'F' && id !== 'dur') calculateSystem();
    }

    function onDofChange() {
        resetSimulation();
        const c=parseInt(document.getElementById('dof-select').value), d=document.getElementById('damping-container');
        d.innerHTML='';
        for(let i=1; i<=c; i++) d.innerHTML+=`<div class="label-row"><label style="width:30px">Œ∂${i}:</label><div class="input-group" style="flex:1"><input type="range" id="slide-z${i}" min="0" max="1" step="0.01" value="0.02" oninput="syncZeta(${i},true)"><input type="number" id="num-z${i}" value="0.02" min="0" max="1" step="0.01" oninput="syncZeta(${i},false)"></div></div>`;
        drawFrame(new Array(c).fill(0));
        calculateSystem();
    }

    window.syncZeta=function(i,s){const sl=document.getElementById(`slide-z${i}`),nm=document.getElementById(`num-z${i}`); if(s) nm.value=sl.value; else sl.value=nm.value;}

    function getDampingValues() { const c=parseInt(document.getElementById('dof-select').value); let a=[]; for(let i=1; i<=c; i++) a.push(parseFloat(document.getElementById(`num-z${i}`).value)); return a; }

    function toggleDuration(){ document.getElementById('dur-box').style.display = document.getElementById('force-type').value==='pulse'?'block':'none'; }

    function updateProfileType() { const t=document.getElementById('profile-type').value, b=document.getElementById('geo-inputs'); if(t==='circle') b.innerHTML=`<div class="label-row"><label>Radius (r) [m]:</label></div><div class="input-group"><input type="range" id="slide-r" min="0.1" max="0.6" step="0.01" value="0.25" oninput="syncInputs('r',true)"><input type="number" id="num-r" value="0.25" min="0.01" max="0.6" step="0.01" oninput="syncInputs('r',false)" onchange="validateInput('r')"></div>`; else b.innerHTML=`<div class="label-row"><label>Width (b) [m]:</label></div><div class="input-group"><input type="range" id="slide-b" min="0.1" max="1.0" step="0.01" value="0.4" oninput="syncInputs('b',true)"><input type="number" id="num-b" value="0.4" min="0.01" max="1.0" step="0.01" oninput="syncInputs('b',false)" onchange="validateInput('b')"></div><div class="label-row"><label>Height (h) [m]:</label></div><div class="input-group"><input type="range" id="slide-h" min="0.1" max="1.0" step="0.01" value="0.4" oninput="syncInputs('h',true)"><input type="number" id="num-h" value="0.4" min="0.01" max="1.0" step="0.01" oninput="syncInputs('h',false)" onchange="validateInput('h')"></div>`; updateGeometry(); calculateSystem(); }

    function updateGeometry() { const t=document.getElementById('profile-type').value; let I=0; if(t==='circle'){const el=document.getElementById('num-r'); const r=el?parseFloat(el.value):0.25; I=Math.PI*Math.pow(r,4)/4;} else {const elB=document.getElementById('num-b'), elH=document.getElementById('num-h'); const b=elB?parseFloat(elB.value):0.4, h=elH?parseFloat(elH.value):0.4; I=b*Math.pow(h,3)/12;} document.getElementById('val-Ic').innerText=I.toFixed(6); }

    function getModelPayload() { const dofs=parseInt(document.getElementById('dof-select').value), E=parseFloat(document.getElementById('num-E').value), M=parseFloat(document.getElementById('num-M').value), t=document.getElementById('profile-type').value; let I=0; if(t==='circle'){const el=document.getElementById('num-r'); I=el?Math.PI*Math.pow(parseFloat(el.value),4)/4:0.003;} else {const elB=document.getElementById('num-b'), elH=document.getElementById('num-h'); const b=elB?parseFloat(elB.value):0.4, h=elH?parseFloat(elH.value):0.4; I=b*Math.pow(h,3)/12;} const arr=(v)=>Array(dofs).fill().map(()=>Array(2).fill(v)); return { "Hc":arr(3.0), "Ec":arr(E), "Ic":arr(I), "Lb":arr(6.0), "depth":6.0, "floor_load":M, "base_condition":1, "damping_ratios":getDampingValues() }; }

    async function calculateSystem() {
        try {
            console.log("Fetching matrices...");
            const res = await fetch(`${API_URL}/shear-building/modal`, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(getModelPayload()) });
            if(!res.ok) throw new Error("Server error");
            const data = await res.json();
            const newPeriods = data.frequencies.map(w => 2*Math.PI/w);
            if(newPeriods.length !== systemPeriods.length) {
                systemPeriods = newPeriods;
                initTabsAndCharts(systemPeriods);
            } else {
                systemPeriods = newPeriods;
                const btns = document.querySelectorAll('.tab-btn');
                btns.forEach((b, i) => { if(systemPeriods[i]) b.innerText = `Mode ${i+1} (T=${systemPeriods[i].toFixed(3)}s)`; });
                activeCharts.forEach((obj, i) => {
                    obj.period = systemPeriods[i];
                    obj.chart.options.scales.x.title.text = `Normalized Time (t / T${i+1})`;
                    obj.chart.options.scales.x.customPeriod = systemPeriods[i];
                    obj.chart.update('none');
                });
            }

            const presetsDiv = document.getElementById('mode-presets');
            if(presetsDiv) {
                presetsDiv.innerHTML = '';
                data.frequencies.forEach((w, i) => {
                    const freqHz = w / (2 * Math.PI);
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.style.cssText = "font-size:0.65rem; padding:1px 4px; flex:1; background:#0f172a; border-color:#38bdf8; color:#38bdf8; min-height:20px;";
                    btn.innerText = `Set M${i+1} (${freqHz.toFixed(2)})`;
                    btn.title = `Set Frequency to Mode ${i+1} (${freqHz.toFixed(4)} Hz)`;
                    btn.onclick = () => setFreqFromMode(freqHz, w);
                    presetsDiv.appendChild(btn);
                });
            }

            let h=`<table class="modes-table"><tr><th>Mode</th><th>Freq</th><th>T</th></tr>`;
            data.frequencies.forEach((w,i)=> {
                const freqHz = w / (2 * Math.PI);
                h+=`<tr>
                        <td>${i+1}</td>
                        <td>${freqHz.toFixed(3)} Hz</td>
                        <td style="color:#38bdf8">${(2*Math.PI/w).toFixed(3)}s</td>
                    </tr>`;
            });
            h+=`</table><span class="mat-label">Mass [M] (kN¬∑s¬≤/m):</span>`;
            data.M_matrix.forEach(r=>h+=`<div class="mat-row">[ ${r.map(n=>(n/1000).toFixed(2)).join(", ")} ]</div>`);
            h+=`<span class="mat-label">Stiffness [K] (kN/m):</span>`;
            data.K_matrix.forEach(r=>h+=`<div class="mat-row">[ ${r.map(n=>(n/1000).toLocaleString('en-US', {maximumFractionDigits:0})).join(", ")} ]</div>`);
            document.getElementById("results-area").innerHTML = h;
        } catch(e){ console.error(e); document.getElementById("results-area").innerText = "Error calculating system properties. Is server running?"; }
    }

    function drawFrame(disps) {
        const c=document.getElementById("vizCanvas");
        if(!c) return;
        const ctx=c.getContext("2d"), r=c.parentElement.getBoundingClientRect();
        c.width=r.width; c.height=r.height;
        const w=c.width, h=c.height, f=disps.length;
        const dMax = Math.max(maxAbsDisp, 0.001);
        const sX = (w*0.3)/dMax;
        const fH = (h*0.8)/f;
        ctx.fillStyle="#000"; ctx.fillRect(0,0,w,h);
        ctx.lineWidth=3; ctx.lineCap="round";
        const cx=w/2, gy=h-20;
        const groundWidth=400, buildWidth=200;
        ctx.strokeStyle="#444"; ctx.beginPath(); ctx.moveTo(cx - groundWidth/2, gy); ctx.lineTo(cx + groundWidth/2, gy); ctx.stroke();
        for(let i=0;i<f;i++){
            const yB=gy-i*fH, yT=gy-(i+1)*fH, xB=(i===0)?0:disps[i-1]*sX, xT=disps[i]*sX, halfW=buildWidth/2;
            ctx.strokeStyle="#38bdf8"; ctx.beginPath(); ctx.moveTo(cx-halfW+xB,yB); ctx.lineTo(cx-halfW+xT,yT); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx+halfW+xB,yB); ctx.lineTo(cx+halfW+xT,yT); ctx.stroke();
            ctx.strokeStyle="#fff"; ctx.beginPath(); ctx.moveTo(cx-halfW+xT,yT); ctx.lineTo(cx+halfW+xT,yT); ctx.stroke();
            ctx.fillStyle="#ef4444"; ctx.beginPath(); ctx.arc(cx+xT,yT,6,0,6.28); ctx.fill();
            ctx.fillStyle="#ffffff"; ctx.font="bold 14px Consolas"; ctx.textAlign="center"; ctx.fillText(`M${i+1}`, cx + xT, yT - 15);
        }
    }
</script>
</body>
</html>